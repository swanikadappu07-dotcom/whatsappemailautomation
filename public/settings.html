<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - WhatsApp Automation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            margin: 5px 0;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .sidebar .nav-link.active {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        .main-content {
            background: #f8f9fa;
            min-height: 100vh;
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border-radius: 10px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        .btn-success {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            border: none;
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #1ea952 0%, #0f7a6b 100%);
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-connected {
            background-color: #28a745;
        }
        .status-disconnected {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4 class="text-white"><i class="fab fa-whatsapp"></i> WhatsApp Automation</h4>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/contacts.html">
                                <i class="fas fa-users me-2"></i> Contacts
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/messages.html">
                                <i class="fas fa-comments me-2"></i> Messages
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/templates.html">
                                <i class="fas fa-file-alt me-2"></i> Templates
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/appointments.html">
                                <i class="fas fa-calendar me-2"></i> Appointments
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/billing.html">
                                <i class="fas fa-receipt me-2"></i> Billing
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#settings">
                                <i class="fas fa-cog me-2"></i> Settings
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Settings</h1>
                </div>

                <!-- WhatsApp Configuration -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fab fa-whatsapp me-2"></i> WhatsApp Business API Configuration
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <form id="whatsappConfigForm">
                                    <div class="mb-3">
                                        <label for="accessToken" class="form-label">Access Token *</label>
                                        <input type="text" class="form-control" id="accessToken" required>
                                        <div class="form-text">Your WhatsApp Business API access token</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="phoneNumberId" class="form-label">Phone Number ID *</label>
                                        <input type="text" class="form-control" id="phoneNumberId" required>
                                        <div class="form-text">Your WhatsApp Business phone number ID</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="verifyToken" class="form-label">Verify Token</label>
                                        <input type="text" class="form-control" id="verifyToken">
                                        <div class="form-text">Webhook verification token</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="webhookUrl" class="form-label">Webhook URL</label>
                                        <input type="url" class="form-control" id="webhookUrl" placeholder="https://your-domain.com/webhook">
                                        <div class="form-text">Your webhook endpoint for receiving messages</div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save Configuration
                                    </button>
                                </form>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6>Current Status</h6>
                                        <div id="currentStatus">
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="status-indicator status-disconnected"></span>
                                                <span>WhatsApp API: <strong>Not Connected</strong></span>
                                            </div>
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="status-indicator status-disconnected"></span>
                                                <span>Phone Number: <strong>Not Set</strong></span>
                                            </div>
                                        </div>
                                        <hr>
                                        <h6>Test Connection</h6>
                                        <button type="button" class="btn btn-success btn-sm" onclick="testConnection()">
                                            <i class="fas fa-play"></i> Test WhatsApp API
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Quick Actions</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="d-grid">
                                    <button class="btn btn-outline-primary" onclick="sendTestMessage()">
                                        <i class="fas fa-paper-plane"></i> Send Test Message
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-grid">
                                    <button class="btn btn-outline-info" onclick="checkPhoneNumbers()">
                                        <i class="fas fa-phone"></i> Check Phone Numbers
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-grid">
                                    <button class="btn btn-outline-warning" onclick="viewTemplates()">
                                        <i class="fas fa-file-alt"></i> View Templates
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuration Guide -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Setup Guide</h6>
                    </div>
                    <div class="card-body">
                        <div class="accordion" id="setupGuide">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingOne">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                                        Step 1: Get WhatsApp Business API Access
                                    </button>
                                </h2>
                                <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#setupGuide">
                                    <div class="accordion-body">
                                        <ol>
                                            <li>Go to <a href="https://developers.facebook.com/" target="_blank">Facebook Developers</a></li>
                                            <li>Create a new app and select "Business" type</li>
                                            <li>Add WhatsApp Business API product</li>
                                            <li>Get your Access Token from the app dashboard</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingTwo">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                                        Step 2: Configure Phone Number
                                    </button>
                                </h2>
                                <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#setupGuide">
                                    <div class="accordion-body">
                                        <ol>
                                            <li>In your WhatsApp Business API dashboard</li>
                                            <li>Go to "Phone Numbers" section</li>
                                            <li>Add your business phone number</li>
                                            <li>Copy the Phone Number ID</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingThree">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree">
                                        Step 3: Test Your Setup
                                    </button>
                                </h2>
                                <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#setupGuide">
                                    <div class="accordion-body">
                                        <ol>
                                            <li>Save your configuration above</li>
                                            <li>Click "Test WhatsApp API" button</li>
                                            <li>Send a test message to verify everything works</li>
                                            <li>Check the message delivery status</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:3001/api' : '/api';
        let AUTH_TOKEN = localStorage.getItem('authToken') || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2OGZiOTc2NWNmODliOTk5Y2I5MTE2MzYiLCJyb2xlIjoiY2xpZW50IiwiaWF0IjoxNzYxMzE4NzU3LCJleHAiOjE3NjE5MjM1NTd9.do__gZ981-dwK2lbQlwgRkpzImHI6tgYfLPAi8NZROg';

        // Login and get token
        async function login() {
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'joshua@example.com',
                        password: 'password123'
                    })
                });
                const data = await response.json();
                AUTH_TOKEN = data.token;
                console.log('Logged in successfully');
                loadCurrentConfig();
            } catch (error) {
                console.error('Login failed:', error);
                alert('Login failed. Please check the server.');
            }
        }

        // Load current configuration
        async function loadCurrentConfig() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                const data = await response.json();
                
                if (data.user && data.user.whatsappConfig) {
                    const config = data.user.whatsappConfig;
                    document.getElementById('accessToken').value = config.accessToken || '';
                    document.getElementById('phoneNumberId').value = config.phoneNumberId || '';
                    document.getElementById('verifyToken').value = config.verifyToken || '';
                    document.getElementById('webhookUrl').value = config.webhookUrl || '';
                    
                    updateStatus(config);
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        // Update status display
        function updateStatus(config) {
            const statusDiv = document.getElementById('currentStatus');
            const isConnected = config.isActive && config.accessToken && config.phoneNumberId;
            
            statusDiv.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <span class="status-indicator ${isConnected ? 'status-connected' : 'status-disconnected'}"></span>
                    <span>WhatsApp API: <strong>${isConnected ? 'Connected' : 'Not Connected'}</strong></span>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <span class="status-indicator ${config.phoneNumberId ? 'status-connected' : 'status-disconnected'}"></span>
                    <span>Phone Number: <strong>${config.phoneNumberId || 'Not Set'}</strong></span>
                </div>
            `;
        }

        // Save WhatsApp configuration
        document.getElementById('whatsappConfigForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const accessToken = document.getElementById('accessToken').value;
            const phoneNumberId = document.getElementById('phoneNumberId').value;
            const verifyToken = document.getElementById('verifyToken').value;
            const webhookUrl = document.getElementById('webhookUrl').value;
            
            try {
                const response = await fetch(`${API_BASE}/auth/whatsapp-config`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        accessToken,
                        phoneNumberId,
                        verifyToken,
                        webhookUrl
                    })
                });
                
                if (response.ok) {
                    alert('WhatsApp configuration saved successfully!');
                    loadCurrentConfig();
                } else {
                    const errorData = await response.json();
                    if (errorData.message && errorData.message.includes('expired')) {
                        alert('Error: Your WhatsApp Access Token has expired. Please get a new token from Facebook Developers and try again.');
                    } else {
                        alert('Error saving configuration: ' + (errorData.message || 'Unknown error'));
                    }
                }
            } catch (error) {
                console.error('Error saving config:', error);
                alert('Error saving configuration');
            }
        });

        // Test connection
        async function testConnection() {
            try {
                const response = await fetch(`${API_BASE}/whatsapp/test`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('WhatsApp API connection successful!');
                } else {
                    alert('WhatsApp API connection failed: ' + data.message);
                }
            } catch (error) {
                console.error('Error testing connection:', error);
                alert('Error testing connection');
            }
        }

        // Send test message
        async function sendTestMessage() {
            if (confirm('This will send a test message to your first contact. Continue?')) {
                try {
                    const response = await fetch(`${API_BASE}/messages/send`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AUTH_TOKEN}`
                        },
                        body: JSON.stringify({
                            contactId: '68fa4022c64ab6262957d4cd', // John Smith
                            type: 'text',
                            content: 'Hello! This is a test message from your WhatsApp Business automation system. If you receive this, your setup is working correctly!'
                        })
                    });
                    
                    if (response.ok) {
                        alert('Test message sent successfully!');
                    } else {
                        alert('Error sending test message');
                    }
                } catch (error) {
                    console.error('Error sending test message:', error);
                    alert('Error sending test message');
                }
            }
        }

        // Check phone numbers
        async function checkPhoneNumbers() {
            try {
                const response = await fetch(`${API_BASE}/whatsapp/phone-numbers`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                const data = await response.json();
                
                if (data.phoneNumbers) {
                    alert('Available phone numbers: ' + data.phoneNumbers.join(', '));
                } else {
                    alert('No phone numbers found or error: ' + data.message);
                }
            } catch (error) {
                console.error('Error checking phone numbers:', error);
                alert('Error checking phone numbers');
            }
        }

        // View templates
        function viewTemplates() {
            window.open('/messages.html', '_blank');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', login);
    </script>
</body>
</html>
