<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Templates - WhatsApp Automation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            margin: 5px 0;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .sidebar .nav-link.active {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        .main-content {
            background: #f8f9fa;
            min-height: 100vh;
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border-radius: 10px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        .btn-success {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            border: none;
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #1ea952 0%, #0f7a6b 100%);
        }
        .template-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.3s;
        }
        .template-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 12px;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-approved { background: #d4edda; color: #155724; }
        .status-rejected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4 class="text-white"><i class="fab fa-whatsapp"></i> WhatsApp Automation</h4>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/contacts.html">
                                <i class="fas fa-users me-2"></i> Contacts
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/messages.html">
                                <i class="fas fa-comments me-2"></i> Messages
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#templates">
                                <i class="fas fa-file-alt me-2"></i> Templates
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/appointments.html">
                                <i class="fas fa-calendar me-2"></i> Appointments
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/billing.html">
                                <i class="fas fa-receipt me-2"></i> Billing
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/settings.html">
                                <i class="fas fa-cog me-2"></i> Settings
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Message Templates</h1>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-primary" onclick="syncTemplates()">
                            <i class="fas fa-sync"></i> Sync Templates
                        </button>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTemplateModal">
                            <i class="fas fa-plus"></i> Create Template
                        </button>
                    </div>
                </div>

                <!-- Templates List -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="m-0 font-weight-bold text-primary">Your Templates</h6>
                            </div>
                            <div class="card-body">
                                <div id="templatesList">
                                    <div class="text-center">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Loading templates...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Create Template Modal -->
    <div class="modal fade" id="createTemplateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createTemplateForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="templateName" class="form-label">Template Name</label>
                                    <input type="text" class="form-control" id="templateName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="templateCategory" class="form-label">Category</label>
                                    <select class="form-select" id="templateCategory" required>
                                        <option value="">Select Category</option>
                                        <option value="MARKETING">Marketing</option>
                                        <option value="UTILITY">Utility</option>
                                        <option value="AUTHENTICATION">Authentication</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="templateLanguage" class="form-label">Language</label>
                            <select class="form-select" id="templateLanguage" required>
                                <option value="en">English</option>
                                <option value="hi">Hindi</option>
                                <option value="es">Spanish</option>
                                <option value="fr">French</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="templateBody" class="form-label">Template Body</label>
                            <textarea class="form-control" id="templateBody" rows="4" 
                                placeholder="Enter your template message. Use {{1}}, {{2}}, etc. for variables." required></textarea>
                            <div class="form-text">Use {{1}}, {{2}}, etc. for dynamic variables</div>
                        </div>
                        <div class="mb-3">
                            <label for="templateHeader" class="form-label">Header (Optional)</label>
                            <input type="text" class="form-control" id="templateHeader" placeholder="Template header">
                        </div>
                        <div class="mb-3">
                            <label for="templateFooter" class="form-label">Footer (Optional)</label>
                            <input type="text" class="form-control" id="templateFooter" placeholder="Template footer">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createTemplate()">Create Template</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Template Modal -->
    <div class="modal fade" id="testTemplateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Test Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="testTemplateForm">
                        <div class="mb-3">
                            <label for="testPhoneNumber" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="testPhoneNumber" placeholder="+1234567890" required>
                        </div>
                        <div class="mb-3">
                            <label for="testVariables" class="form-label">Variables (comma separated)</label>
                            <input type="text" class="form-control" id="testVariables" placeholder="John, $100, Dec 25">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="testTemplate()">Send Test</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:3001/api';
        let AUTH_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2OGZhM2U4YWZkY2IxYzBiYmM0YzJmOGQiLCJyb2xlIjoiY2xpZW50IiwiaWF0IjoxNzYxMjg1NzU3LCJleHAiOjE3NjE4OTA1NTd9.T52QCyxLzQkiPm7jm-_5Qsc_ajgs0raSEJmaz4ZBNwc';
        let templates = [];
        let currentTemplateId = null;

        // Login and get token
        async function login() {
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'joshua@example.com',
                        password: 'password123'
                    })
                });
                const data = await response.json();
                AUTH_TOKEN = data.token;
                console.log('Logged in successfully');
                loadTemplates();
            } catch (error) {
                console.error('Login failed:', error);
                document.getElementById('templatesList').innerHTML = '<div class="alert alert-danger">Login failed. Please check the server.</div>';
            }
        }

        // Load templates
        async function loadTemplates() {
            try {
                const response = await fetch(`${API_BASE}/templates`, {
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });
                const data = await response.json();
                templates = data.templates || [];
                displayTemplates();
            } catch (error) {
                console.error('Error loading templates:', error);
                document.getElementById('templatesList').innerHTML = '<div class="alert alert-danger">Error loading templates.</div>';
            }
        }

        // Display templates
        function displayTemplates() {
            const container = document.getElementById('templatesList');
            if (templates.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No templates found. Create your first template!</div>';
                return;
            }

            let html = '';
            templates.forEach(template => {
                const statusClass = template.status === 'APPROVED' ? 'status-approved' : 
                                  template.status === 'REJECTED' ? 'status-rejected' : 'status-pending';
                
                html += `
                    <div class="template-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-2">${template.name}</h6>
                                <p class="text-muted mb-2">${template.components[0]?.text || 'No content'}</p>
                                <div class="d-flex gap-2">
                                    <span class="badge ${statusClass}">${template.status || 'DRAFT'}</span>
                                    <span class="badge bg-secondary">${template.category}</span>
                                    <span class="badge bg-info">${template.language}</span>
                                </div>
                            </div>
                            <div class="btn-group-vertical">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewTemplate('${template._id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="testTemplateModal('${template._id}')" 
                                    ${template.status !== 'APPROVED' ? 'disabled' : ''}>
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTemplate('${template._id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Create template
        async function createTemplate() {
            const name = document.getElementById('templateName').value;
            const category = document.getElementById('templateCategory').value;
            const language = document.getElementById('templateLanguage').value;
            const body = document.getElementById('templateBody').value;
            const header = document.getElementById('templateHeader').value;
            const footer = document.getElementById('templateFooter').value;

            if (!name || !category || !language || !body) {
                alert('Please fill in all required fields');
                return;
            }

            const components = [
                {
                    type: 'BODY',
                    text: body
                }
            ];

            if (header) {
                components.unshift({
                    type: 'HEADER',
                    text: header
                });
            }

            if (footer) {
                components.push({
                    type: 'FOOTER',
                    text: footer
                });
            }

            try {
                const response = await fetch(`${API_BASE}/templates`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        name,
                        category,
                        language,
                        components
                    })
                });

                if (response.ok) {
                    alert('Template created successfully!');
                    document.getElementById('createTemplateForm').reset();
                    bootstrap.Modal.getInstance(document.getElementById('createTemplateModal')).hide();
                    loadTemplates();
                } else {
                    const error = await response.json();
                    alert('Error creating template: ' + error.message);
                }
            } catch (error) {
                console.error('Error creating template:', error);
                alert('Error creating template');
            }
        }

        // Test template modal
        function testTemplateModal(templateId) {
            currentTemplateId = templateId;
            const modal = new bootstrap.Modal(document.getElementById('testTemplateModal'));
            modal.show();
        }

        // Test template
        async function testTemplate() {
            const phoneNumber = document.getElementById('testPhoneNumber').value;
            const variables = document.getElementById('testVariables').value;

            if (!phoneNumber) {
                alert('Please enter a phone number');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/templates/${currentTemplateId}/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        phoneNumber,
                        variables: variables ? variables.split(',').map(v => v.trim()) : []
                    })
                });

                if (response.ok) {
                    alert('Test message sent successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('testTemplateModal')).hide();
                } else {
                    const error = await response.json();
                    alert('Error sending test: ' + error.message);
                }
            } catch (error) {
                console.error('Error testing template:', error);
                alert('Error testing template');
            }
        }

        // Delete template
        async function deleteTemplate(templateId) {
            if (!confirm('Are you sure you want to delete this template?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/templates/${templateId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });

                if (response.ok) {
                    alert('Template deleted successfully!');
                    loadTemplates();
                } else {
                    const error = await response.json();
                    alert('Error deleting template: ' + error.message);
                }
            } catch (error) {
                console.error('Error deleting template:', error);
                alert('Error deleting template');
            }
        }

        // Sync templates
        async function syncTemplates() {
            try {
                const response = await fetch(`${API_BASE}/templates/sync`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                });

                if (response.ok) {
                    alert('Templates synced successfully!');
                    loadTemplates();
                } else {
                    const error = await response.json();
                    alert('Error syncing templates: ' + error.message);
                }
            } catch (error) {
                console.error('Error syncing templates:', error);
                alert('Error syncing templates');
            }
        }

        // View template
        function viewTemplate(templateId) {
            const template = templates.find(t => t._id === templateId);
            if (template) {
                alert(`Template: ${template.name}\n\nContent: ${template.components[0]?.text || 'No content'}\n\nStatus: ${template.status || 'DRAFT'}`);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', login);
    </script>
</body>
</html>
